<ion-card>
  <ion-card-content>
    <form (ngSubmit)="guardar()" #form="ngForm">
      
      @if (cargando) {
        <div class="cargando-container">
          <ion-spinner></ion-spinner>
          <p>Cargando datos del paciente...</p>
        </div>
      }

      @if (!cargando) {
        <ion-grid>
          <ion-row>
            <ion-col size="12" size-md="6">
              <ion-item>
                <ion-label position="stacked">Nombre Completo *</ion-label>
                <ion-input 
                  [(ngModel)]="paciente.nombrePaciente" 
                  name="nombrePaciente"
                  placeholder="Ej: Juan Pérez García"
                  required>
                </ion-input>
              </ion-item>
            </ion-col>

            <ion-col size="12" size-md="6">
              <ion-item>
                <ion-label position="stacked">Correo Electrónico (Opcional)</ion-label>
                <ion-input 
                  type="email" 
                  [(ngModel)]="paciente.correo" 
                  name="correo"
                  placeholder="Dejar vacío para generar automáticamente">
                </ion-input>
              </ion-item>
            </ion-col>
          </ion-row>

          <ion-row>
            <ion-col size="12" size-md="6">
              <ion-item>
                <ion-label position="stacked">Fecha de Nacimiento *</ion-label>
                <ion-input 
                  [(ngModel)]="paciente.fechaNacimiento" 
                  name="fechaNacimiento"
                  type="date"
                  required>
                </ion-input>
              </ion-item>
            </ion-col>

            <ion-col size="12" size-md="6">
              <ion-item>
                <ion-label position="stacked">Teléfono</ion-label>
                <ion-input 
                  [(ngModel)]="paciente.telefono" 
                  name="telefono"
                  placeholder="+569 1234 5678">
                </ion-input>
              </ion-item>
            </ion-col>
          </ion-row>

          <ion-row>
            <ion-col size="12" size-md="4">
              <ion-item>
                <ion-label position="stacked">Sexo</ion-label>
                <ion-select [(ngModel)]="paciente.sexo" name="sexo">
                  <ion-select-option value="masculino">Masculino</ion-select-option>
                  <ion-select-option value="femenino">Femenino</ion-select-option>
                  <ion-select-option value="otro">Otro</ion-select-option>
                </ion-select>
              </ion-item>
            </ion-col>

            <ion-col size="12" size-md="4">
              <ion-item>
                <ion-label position="stacked">Previsión</ion-label>
                <ion-select [(ngModel)]="paciente.prevision" name="prevision">
                  <ion-select-option value="FONASA">FONASA</ion-select-option>
                  <ion-select-option value="ISAPRE">ISAPRE</ion-select-option>
                  <ion-select-option value="Particular">Particular</ion-select-option>
                  <ion-select-option value="Otro">Otro</ion-select-option>
                </ion-select>
              </ion-item>
            </ion-col>

            <ion-col size="12" size-md="4">
              <ion-item>
                <ion-label position="stacked">Tipo de Sangre</ion-label>
                <ion-input 
                  [(ngModel)]="paciente.tipoSangre" 
                  name="tipoSangre"
                  placeholder="Ej: O+">
                </ion-input>
              </ion-item>
            </ion-col>
          </ion-row>

          <ion-row>
            <ion-col size="12">
              <ion-item>
                <ion-label position="stacked">Dirección</ion-label>
                <ion-textarea 
                  [(ngModel)]="paciente.direccion" 
                  name="direccion"
                  placeholder="Dirección completa"
                  rows="2">
                </ion-textarea>
              </ion-item>
            </ion-col>
          </ion-row>

          <ion-row>
            <ion-col size="12" size-md="6">
              <ion-item>
                <ion-label position="stacked">Rol en la Familia</ion-label>
                <ion-select [(ngModel)]="paciente.rolFamiliar" name="rolFamiliar">
                  @for (rol of rolesFamilia; track rol.value) {
                    <ion-select-option [value]="rol.value">{{ rol.label }}</ion-select-option>
                  }
                </ion-select>
              </ion-item>
            </ion-col>
          </ion-row>

          <ion-row>
            <ion-col size="12" size-md="6">
              <ion-item>
                <ion-label position="stacked">Ocupación</ion-label>
                <ion-input 
                  [(ngModel)]="paciente.ocupacion" 
                  name="ocupacion"
                  placeholder="Ej: Ingeniero, Doctor, etc.">
                </ion-input>
              </ion-item>
            </ion-col>

            <ion-col size="12" size-md="6">
              <ion-item>
                <ion-label position="stacked">Nacionalidad</ion-label>
                <ion-input 
                  [(ngModel)]="paciente.nacionalidad" 
                  name="nacionalidad"
                  placeholder="Ej: Chilena">
                </ion-input>
              </ion-item>
            </ion-col>
          </ion-row>

          <ion-row>
            <ion-col size="12" class="botones-accion">
              <ion-button 
                type="submit" 
                color="tertiary"
                expand="block"
                [disabled]="guardando || !form.valid">
                <ion-icon name="save" slot="start"></ion-icon>
                <ion-spinner *ngIf="guardando" name="crescent"></ion-spinner>
                {{ guardando ? 'Guardando...' : (modo === 'crear' ? 'Crear Paciente' : 'Actualizar Paciente') }}
              </ion-button>

              <ion-button 
                color="medium" 
                expand="block" 
                fill="outline"
                (click)="cancelar()"
                [disabled]="guardando">
                <ion-icon name="close" slot="start"></ion-icon>
                Cancelar
              </ion-button>
            </ion-col>
          </ion-row>
        </ion-grid>
      }
    </form>
  </ion-card-content>

  <!-- Agregar esto al final del formulario, antes de cerrar el ion-card -->
<ion-card>
  <ion-card-content>
    <div class="form-actions">
      <ion-button 
        expand="block" 
        color="primary" 
        (click)="guardar()"
        [disabled]="guardando || cargando">
        <ion-spinner *ngIf="guardando" name="crescent" slot="start"></ion-spinner>
        <ion-icon *ngIf="!guardando" name="save" slot="start"></ion-icon>
        {{ modo === 'crear' ? 'Crear Paciente' : 'Actualizar Paciente' }}
      </ion-button>

      <ion-button 
        expand="block" 
        color="medium" 
        fill="outline" 
        (click)="cancelar()"
        [disabled]="guardando">
        <ion-icon name="close" slot="start"></ion-icon>
        Cancelar
      </ion-button>
    </div>
  </ion-card-content>
</ion-card>


</ion-card>

<ion-toast
  [isOpen]="mostrarToast"
  [message]="mensajeToast"
  [duration]="5000" 
  [color]="tipoToast"
  (didDismiss)="mostrarToast = false">
</ion-toast>
